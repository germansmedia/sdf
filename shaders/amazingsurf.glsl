#define AMAZINGSURF_SCALE 1.5
#define AMAZINGSURF_MINR 0.5
#define AMAZINGSURF_FOLD 1.0
#define AMAZINGSURF_VARY 0.0
//#define AMAZINGSURF_ROTATION MAT3(1.0,0.0,0.0, 0.0,1.0,0.0, 0.0,0.0,1.0)
//#define AMAZINGSURF_ROTATION MAT3(0.9985012,-0.0055561,0.0544474, -0.0000000,0.9948338,0.1015173, -0.0547301,-0.1013652,0.9933427)
//#define AMAZINGSURF_ROTATION MAT3(0.9027011,-0.3816559,0.1986693,0.4057410,0.9087359,-0.0978434,-0.1431954,0.1689316,0.9751703)
//#define AMAZINGSURF_ROTATION MAT3(0.9987503,0.0000000,0.0499792,0.0004998,0.9999500,-0.0099873,-0.0499767,0.0099998,0.9987003)
//#define AMAZINGSURF_ROTATION MAT3(0.1675374,0.7181091,0.6754632,0.7170973,-0.5589388,0.4163638,0.6765372,0.4146163,-0.6085973)
//#define AMAZINGSURF_ROTATION MAT3(0.0804642,0.2720106,-0.9589243,-0.0111730,0.9622294,0.2720106,0.9966949,-0.0111730,0.0804642)
#define AMAZINGSURF_ROTATION MAT3(0.8985685,0.3018993,-0.3184831,-0.2057494,0.9308727,0.3018993,0.3876104,-0.2057494,0.8985685)

void amazingsurf(inout VEC3 v,inout FLOAT dr,VEC3 c,inout FLOAT m) {

    FLOAT q = AMAZINGSURF_SCALE + AMAZINGSURF_VARY * (abs(AMAZINGSURF_SCALE) - 1.0);

    v.x = abs(v.x + AMAZINGSURF_FOLD) - abs(v.x - AMAZINGSURF_FOLD) - v.x;
    v.y = abs(v.y + AMAZINGSURF_FOLD) - abs(v.y - AMAZINGSURF_FOLD) - v.y;

    FLOAT rr = v.x * v.x + v.y * v.y;
    //FLOAT rr = dot(r,r);

    if (rr < AMAZINGSURF_MINR * AMAZINGSURF_MINR) {
        q /= AMAZINGSURF_MINR * AMAZINGSURF_MINR;
    }
    else if (rr < 1.0) {
        q /= rr;
    }
    v = AMAZINGSURF_ROTATION * (q * v + c);
    dr = dr * q + 1.0;
}
