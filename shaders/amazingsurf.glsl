#define AMAZINGSURF_SCALE 1.5
#define AMAZINGSURF_FOLD 1.0
#define AMAZINGSURF_MINR 0.5
#define AMAZINGSURF_VARY 0.0
//#define AMAZINGSURF_ROTATION MAT3(0.9985012,-0.0055561,0.0544474, -0.0000000,0.9948338,0.1015173, -0.0547301,-0.1013652,0.9933427)
//#define AMAZINGSURF_ROTATION MAT3(0.9027011,-0.3816559,0.1986693,0.4057410,0.9087359,-0.0978434,-0.1431954,0.1689316,0.9751703)
//#define AMAZINGSURF_ROTATION MAT3(0.9987503,0.0000000,0.0499792,0.0004998,0.9999500,-0.0099873,-0.0499767,0.0099998,0.9987003)
#define AMAZINGSURF_ROTATION MAT3(0.1675374,0.7181091,0.6754632,0.7170973,-0.5589388,0.4163638,0.6765372,0.4146163,-0.6085973)

void amazingsurf(inout VEC3 v,inout FLOAT dr,VEC3 c) {

    v = abs(v -AMAZING_FOLD) + v - abs(v + AMAZING_FOLD) + AMAZING_I;


    FLOAT q = AMAZINGSURF_VARY * (abs(AMAZINGSURF_SCALE) - 1.0) + AMAZINGSURF_SCALE;
    //v.x = abs(v.x + AMAZINGSURF_FOLD) - (abs(v.x - AMAZINGSURF_FOLD) + v.x);
    //v.y = abs(v.y + AMAZINGSURF_FOLD) - (abs(v.y - AMAZINGSURF_FOLD) + v.y);
    v.x = abs(v.x - AMAZINGSURF_FOLD) + v.x - abs(v.x + AMAZINGSURF_FOLD);
    v.y = abs(v.y - AMAZINGSURF_FOLD) + v.y - abs(v.y + AMAZINGSURF_FOLD);
    FLOAT rr = dot(v,v);
    if (rr < AMAZINGSURF_MINR * AMAZINGSURF_MINR) {
        q /= AMAZINGSURF_MINR * AMAZINGSURF_MINR;
    }
    else if (rr < 1.0) {
        q /= rr;
    }
    dr = dr * q + 1.0;
    v = AMAZINGSURF_ROTATION * (q * v + c);
    //v = q * v + c;
}
